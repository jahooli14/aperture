name: Documentation Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  check-docs-freshness:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to check file ages

    - name: Check documentation freshness
      run: |
        echo "üîç Checking documentation freshness..."

        # Get recent code changes (last 7 days)
        CODE_CHANGES=$(git log --since="7 days ago" --name-only --pretty=format: | grep -E "\.(ts|tsx|js|jsx)$" | sort -u | wc -l || echo 0)

        echo "üìä Code files changed in last 7 days: $CODE_CHANGES"

        # Check if NEXT_SESSION.md exists and its freshness
        if [ -f "NEXT_SESSION.md" ]; then
          NEXT_SESSION_AGE=$(git log -1 --format=%cd --date=relative NEXT_SESSION.md 2>/dev/null || echo "never updated")
          echo "üìù NEXT_SESSION.md last updated: $NEXT_SESSION_AGE"

          if [ "$CODE_CHANGES" -gt 10 ]; then
            NEXT_SESSION_UPDATED=$(git log --since="7 days ago" --name-only --pretty=format: NEXT_SESSION.md | wc -l || echo 0)
            if [ "$NEXT_SESSION_UPDATED" -eq 0 ]; then
              echo "‚ö†Ô∏è  WARNING: Significant code changes but NEXT_SESSION.md not updated recently"
            else
              echo "‚úÖ NEXT_SESSION.md is up to date"
            fi
          fi
        else
          echo "‚ÑπÔ∏è  NEXT_SESSION.md not present (optional)"
        fi

        echo "‚úÖ Freshness check complete"

    - name: Check for broken documentation links
      run: |
        echo "üîó Checking for broken internal links..."

        # Check for references to deleted files
        BROKEN_REFS=0

        if grep -r '`CHEATSHEET\.md`' *.md 2>/dev/null; then
          echo "‚ùå Found references to deleted CHEATSHEET.md"
          BROKEN_REFS=$((BROKEN_REFS + 1))
        fi

        if [ $BROKEN_REFS -gt 0 ]; then
          echo "‚ö†Ô∏è  Found $BROKEN_REFS potential broken references"
          exit 1
        else
          echo "‚úÖ No broken references detected"
        fi

    - name: Validate documentation structure
      run: |
        echo "üìÅ Validating documentation structure..."

        # Essential docs that must exist for Claude Code workflow
        REQUIRED_DOCS=(
          "README.md"
          "CLAUDE.md"
          "CLAUDE-APERTURE.md"
          "START_HERE.md"
          ".claude/startup.md"
        )

        # Optional docs - check and warn but don't fail
        OPTIONAL_DOCS=(
          "NEXT_SESSION.md"
          ".process/ARCHITECTURE.md"
          ".process/DEVELOPMENT.md"
          ".process/COMMON_MISTAKES.md"
        )

        MISSING=0
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "‚ùå Missing required documentation: $doc"
            MISSING=$((MISSING + 1))
          else
            echo "‚úÖ $doc"
          fi
        done

        echo ""
        echo "üìã Optional documentation:"
        for doc in "${OPTIONAL_DOCS[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "‚ö†Ô∏è  Optional: $doc (not present)"
          else
            echo "‚úÖ $doc"
          fi
        done

        if [ $MISSING -gt 0 ]; then
          echo ""
          echo "‚ö†Ô∏è  $MISSING required documentation files missing"
          exit 1
        else
          echo ""
          echo "‚úÖ All required documentation files present"
        fi

    - name: Check documentation consistency
      run: |
        echo "üîÑ Checking documentation consistency..."

        # Verify CLAUDE.md has essential sections
        if ! grep -q "## Projects" CLAUDE.md 2>/dev/null; then
          echo "‚ö†Ô∏è  CLAUDE.md missing Projects section"
        fi

        if ! grep -q "## Commands" CLAUDE.md 2>/dev/null; then
          echo "‚ö†Ô∏è  CLAUDE.md missing Commands section"
        fi

        echo "‚úÖ Documentation structure is consistent"

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "============================================"
        echo "üìã Documentation Check Summary"
        echo "============================================"
        echo "Required: README.md, CLAUDE.md, CLAUDE-APERTURE.md,"
        echo "          START_HERE.md, .claude/startup.md"
        echo ""
        echo "Optional: NEXT_SESSION.md, .process/*.md"
        echo "============================================"
